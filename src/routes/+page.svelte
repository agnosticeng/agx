<script lang="ts">
	import { ContextMenuState } from '$lib/components/ContextMenu';
	import ContextMenu from '$lib/components/ContextMenu/ContextMenu.svelte';
	import { Editor } from '$lib/components/Editor';
	import { SaveQueryModal } from '$lib/components/Queries';
	import Result from '$lib/components/Result.svelte';
	import SideBar from '$lib/components/SideBar.svelte';
	import { SplitPane } from '$lib/components/SplitPane';
	import WindowTitleBar from '$lib/components/WindowTitleBar.svelte';
	import { set_app_context } from '$lib/context';
	import type { Table } from '$lib/olap-engine';
	import { engine, type OLAPResponse } from '$lib/olap-engine';
	import { history_repository, type HistoryEntry } from '$lib/repositories/history';
	import { query_repository, type Query } from '$lib/repositories/queries';
	import type { PageData } from './$types';

	let response = $state.raw<OLAPResponse>();

	let { data }: { data: PageData } = $props();

	let query = $state('');
	let loading = $state(false);

	async function handleExec() {
		if (loading || !query) {
			return;
		}

		loading = true;
		response = await engine.exec(query).finally(() => (loading = false));

		const last = await history_repository.getLast();

		if (response && last?.content !== query) {
			await addHistoryEntry();
		}
	}

	let tables = $state.raw<Table[]>([]);
	let history = $state.raw<HistoryEntry[]>([]);
	let queries = $state.raw<Query[]>([]);

	$effect(() => {
		engine.getSchema().then((t) => {
			tables = t;
		});
	});

	$effect(() => {
		history_repository.getAll().then((entries) => {
			history = entries;
		});
	});

	async function addHistoryEntry() {
		try {
			const entry = await history_repository.add(query);
			history = [entry, ...history];
		} catch (e) {
			console.error(e);
		}
	}

	function handleHistoryClick(entry: HistoryEntry) {
		query = entry.content;
	}

	$effect(() => {
		query_repository.getAll().then((q) => (queries = q));
	});

	let save_query_modal = $state<ReturnType<typeof SaveQueryModal>>();

	function handleKeyDown(event: KeyboardEvent) {
		if (event.key === 's' && event.metaKey) {
			if (query) {
				event.preventDefault();
				save_query_modal?.show();
			}
		}
	}

	const context_menu = new ContextMenuState();
	set_app_context({ context_menu });
</script>

<svelte:window onkeydown={handleKeyDown} />

<ContextMenu state={context_menu} />

<WindowTitleBar>
	{#snippet actions()}
		<button onclick={() => save_query_modal?.show()} disabled={!query}>Save</button>
		<button onclick={handleExec} disabled={loading}>Run</button>
	{/snippet}
</WindowTitleBar>

<section class="screen">
	<SplitPane orientation="horizontal" position="242px" min="242px" max="40%">
		{#snippet a()}
			<SideBar
				{tables}
				{history}
				onHistoryClick={handleHistoryClick}
				{queries}
				onQueryDelete={async (query) => {
					await query_repository.delete(query.id);
					const index = queries.indexOf(query);
					queries = queries.slice(0, index).concat(queries.slice(index + 1));
				}}
				onQueryOpen={(q) => {
					query = q.sql;
				}}
				onQueryRename={async (q) => {
					const updated = await query_repository.update(q);
					const index = queries.findIndex((_q) => _q.id === updated.id);
					if (index !== -1) {
						queries = queries
							.slice(0, index)
							.concat(updated)
							.concat(queries.slice(index + 1));
					}
				}}
			/>
		{/snippet}
		{#snippet b()}
			<SplitPane orientation="vertical" min="20%" max="80%" --color="hsl(0deg 0% 12%)">
				{#snippet a()}
					<Editor bind:value={query} onExec={handleExec} {tables} />
				{/snippet}
				{#snippet b()}
					<Result {response} />
				{/snippet}
			</SplitPane>
		{/snippet}
	</SplitPane>
</section>

<SaveQueryModal
	bind:this={save_query_modal}
	onCreate={async ({ name }) => {
		const q = await query_repository.create(name, query);
		queries = queries.concat(q);
	}}
/>

<style>
	button {
		appearance: none;
		outline: none;
		border: none;
		font-size: 10px;
		font-weight: 500;
		background-color: hsl(0deg 0% 9%);
		padding: 4px 10px;
		border-radius: 3px;

		&:is(:hover, :focus-within):not(:disabled) {
			cursor: pointer;
		}
	}

	.screen {
		padding-top: var(--window-title-bar-height);
		height: 100vh;
		width: 100vw;
	}
</style>
